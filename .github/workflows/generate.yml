name: ðŸš€ Force Video Generation

on:
  push:
    paths:
      - "data_berita.txt"
      - "videogen_beta.py"
      - ".github/workflows/generate.yml"
  workflow_dispatch:

jobs:
  build_video:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 3. Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfreetype6-dev ffmpeg xvfb
          python -m pip install --upgrade pip
          pip install moviepy==1.0.3 pillow>=9.0.0 numpy>=1.20.0

      - name: 4. Setup Virtual Display
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 2

      - name: 5. Create Test Data
        run: |
          cat > data_berita.txt << 'TESTDATA'
          Breaking News: Harga BBM [[important:naik drastis]] hari ini.

          Pemerintah mengumumkan kenaikan [[warning:Rp 2000 per liter]] untuk BBM.

          Masyarakat diminta [[success:tetap tenang]] dan tidak panic buying.

          Kebijakan ini [[fast:berlaku segera]] mempengaruhi transportasi.

          Kompensasi diberikan kepada [[slow:masyarakat kurang mampu]] via bansos.
          TESTDATA
          echo "Test data created"
          wc -l data_berita.txt

      - name: 6. Modify Script for Forced Generation
        run: |
          cp videogen_beta.py videogen_beta_original.py
          sed -i 's/os.environ.get("GITHUB_ACTIONS")/False/g' videogen_beta.py
          sed -i 's/os.environ.get("CI")/False/g' videogen_beta.py
          echo "Script modified to force video generation"

      - name: 7. Run Video Generation
        run: |
          export DISPLAY=:99
          export FORCE_VIDEO_GENERATION=true
          python videogen_beta.py

      - name: 8. Check Results
        run: |
          echo "Checking generated files..."
          ls -la
          if ls *.mp4 1> /dev/null 2>&1; then
            echo "SUCCESS: Videos generated!"
            ls -la *.mp4
          else
            echo "No MP4 files found"
          fi

      - name: 9. Upload All Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forced-video-results
          path: |
            *.mp4
            *.py
            *.txt
          retention-days: 7
          if-no-files-found: warn
